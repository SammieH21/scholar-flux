[tox]  
envlist = py{310,311,312,313}
isolated_build = True

[gh-actions]
python =
    3.10: py310
    3.11: py311
    3.12: py312
    3.13: py313

[testenv]
allowlist_externals = poetry
passenv = 
    COVERAGE_FILE
commands_pre =
    poetry install --with testing --extras "database cryptography parsing" --sync
commands =
    # Use coverage directly instead of pytest --cov
    poetry run coverage run -m pytest {toxinidir}/tests -rsx
setenv =
    PYTHONPATH = {toxinidir}/src
    COVERAGE_FILE = {toxworkdir}/.coverage.{envname}

[testenv:coverage]
deps = coverage[toml]
skip_install = true
allowlist_externals = 
    bash
    ls
commands = 
    # Debug: see what files exist
    bash -c "ls -la {toxworkdir}/.coverage.* || echo 'No coverage files found'"
    # Combine with explicit pattern
    bash -c "coverage combine {toxworkdir}/.coverage.* || echo 'Combine failed'"
    coverage xml -o {toxinidir}/coverage.xml
    coverage report
depends = py310,py311,py312,py313
